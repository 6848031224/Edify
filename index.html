<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📂 PGS Finder</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f5f5f7; color: #333; }
    header { padding: 1em; background: #e5e5ea; border-bottom: 1px solid #d1d1d6; }
    h1 { margin: 0; font-size: 1.2em; font-weight: 500; }
    #breadcrumbs { margin: 0.5em 0 0; font-size: 0.9em; color: #555; }
    #breadcrumbs span { cursor: pointer; color: #0366d6; }
    #breadcrumbs span:hover { text-decoration: underline; }

    .toolbar { padding: 0.5em 1em; background: #f9f9fa; border-bottom: 1px solid #d1d1d6; display: flex; gap: 1em; align-items: center; }
    input[type="text"] { padding: 0.4em; border: 1px solid #ccc; border-radius: 6px; flex: 1; }
    button { padding: 0.4em 0.8em; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
    button:hover { background: #f0f0f5; }

    ul { list-style: none; padding-left: 1em; margin: 0; }
    li { margin: 0.2em 0; cursor: pointer; padding: 0.3em 0.4em; border-radius: 6px; display: flex; align-items: center; gap: 0.5em; }
    li:hover { background: #e5e5ea; }
    a { text-decoration: none; color: #0366d6; flex: 1; }
    a:hover { text-decoration: underline; }
    .folder { font-weight: 500; }
    .nested { display: none; margin-left: 1em; }
    .active { display: block; }

    .icon { width: 20px; display: inline-block; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>📂 PGS Finder</h1>
    <div id="breadcrumbs"></div>
  </header>
  <div class="toolbar">
    <input type="text" id="search" placeholder="Search..." />
    <button id="expand-all">Expand All</button>
    <button id="collapse-all">Collapse All</button>
  </div>
  <ul id="file-tree"></ul>

  <script>
    const GH_USERNAME = "6848031224";
    const GH_REPO = "Politics-and-Global-Studies-06";

    function getIcon(name, type) {
      if (type === "dir") return "📁";
      const ext = name.split(".").pop().toLowerCase();
      switch (ext) {
        case "pdf": return "📑";
        case "txt": case "md": return "📝";
        case "csv": case "xls": case "xlsx": return "📊";
        case "png": case "jpg": case "jpeg": case "gif": return "🖼️";
        case "mp3": case "wav": return "🎵";
        case "mp4": case "mov": return "🎞️";
        case "zip": case "rar": return "🗂️";
        default: return "📄";
      }
    }

    async function fetchContents(path = "") {
      try {
        const res = await fetch("./file-tree.json");
        const data = await res.json();

        function findPath(arr, targetPath) {
          if (!targetPath || targetPath === "") return arr;
          for (const item of arr) {
            if (item.path === targetPath) return item.children || [];
            if (item.type === "dir" && item.children) {
              const found = findPath(item.children, targetPath);
              if (found) return found;
            }
          }
          return [];
        }

        return findPath(data, path);
      } catch (err) {
        console.error("Error loading JSON:", err);
        return [];
      }
    }

    async function buildTree(container, path = "") {
      const items = await fetchContents(path);

      for (const item of items) {
        const li = document.createElement("li");
        const iconSpan = document.createElement("span");
        iconSpan.className = "icon";
        iconSpan.textContent = getIcon(item.name, item.type);
        li.appendChild(iconSpan);

        if (item.type === "dir") {
          const text = document.createElement("span");
          text.textContent = item.name;
          text.classList.add("folder");

          const nestedUl = document.createElement("ul");
          nestedUl.classList.add("nested");

          li.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (nestedUl.childElementCount === 0) {
              const children = await fetchContents(item.path);
              for (const child of children) {
                const childLi = document.createElement("li");
                const childIcon = document.createElement("span");
                childIcon.className = "icon";
                childIcon.textContent = getIcon(child.name, child.type);
                childLi.appendChild(childIcon);

                if (child.type === "dir") {
                  const childText = document.createElement("span");
                  childText.textContent = child.name;
                  childText.classList.add("folder");
                  const childNested = document.createElement("ul");
                  childNested.classList.add("nested");
                  childLi.appendChild(childText);
                  childLi.appendChild(childNested);

                  childText.addEventListener("click", (ev) => {
                    ev.stopPropagation();
                    childNested.classList.toggle("active");
                    buildTree(childNested, child.path);
                    updateBreadcrumbs(child.path);
                  });
                } else {
                  const link = document.createElement("a");
                  link.href = `https://raw.githubusercontent.com/${GH_USERNAME}/${GH_REPO}/main/${child.path}`;
                  link.textContent = child.name;
                  childLi.appendChild(link);
                }

                nestedUl.appendChild(childLi);
              }
            }
            nestedUl.classList.toggle("active");
            updateBreadcrumbs(item.path);
          });

          li.appendChild(text);
          li.appendChild(nestedUl);
        } else {
          const link = document.createElement("a");
          link.href = `https://raw.githubusercontent.com/${GH_USERNAME}/${GH_REPO}/main/${item.path}`;
          link.textContent = item.name;
          li.appendChild(link);
        }

        container.appendChild(li);
      }
    }

    function updateBreadcrumbs(path) {
      const bc = document.getElementById("breadcrumbs");
      bc.innerHTML = "";
      const parts = path.split("/");
      let accum = "";
      parts.forEach((part, i) => {
        if (i > 0) accum += "/";
        accum += part;
        const span = document.createElement("span");
        span.textContent = part;
        span.addEventListener("click", () => {
          document.getElementById("file-tree").innerHTML = "";
          buildTree(document.getElementById("file-tree"), accum);
        });
        bc.appendChild(span);
        if (i < parts.length - 1) bc.append(" / ");
      });
    }

    document.getElementById("search").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll("li").forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    });

    document.getElementById("expand-all").addEventListener("click", () => {
      document.querySelectorAll(".nested").forEach(ul => ul.classList.add("active"));
    });

    document.getElementById("collapse-all").addEventListener("click", () => {
      document.querySelectorAll(".nested").forEach(ul => ul.classList.remove("active"));
    });

    // Init
    const urlParams = new URLSearchParams(window.location.search);
    const startPath = urlParams.get("path") || "";
    buildTree(document.getElementById("file-tree"), startPath);
    if (startPath) updateBreadcrumbs(startPath);
  </script>
</body>
</html>
